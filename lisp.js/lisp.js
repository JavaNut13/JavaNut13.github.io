function parseType(t){for(type in types){var e=types[type].re.exec(t);if(e){var n=e[0],r=e[1]||n;return{type:type,cont:!types[type].ignore&&r,length:n.length}}}}function parseAtom(t){var e=parseType(t);if(!e)return null;var n=e.length;if(delete e.length,"list-start"===e.type)return parseList(t);if("whitespace"===e.type){var r=parseAtom(t.substring(n));return r.length+=n,r}if("quote"===e.type){var i=parseAtom(t.substring(n));return n+=i.length,delete i.length,e.cont=i.result,{length:n,result:e}}return{length:n,result:e}}function parseList(t){for(var e,n,r=t.startsWith("["),i=t.substring(1),u=1,s=[];result=parseAtom(i);){if(e=result.result,n=result.length,e.cont){if("list-end"===e.type){u+=n;break}s.push(e)}i=i.substring(n),u+=n}return r?{result:{type:"quote",cont:{type:"list",cont:s}},length:u}:{result:{type:"list",cont:s},length:u}}function parseProgram(t){for(var e=t,n=[];result=parseAtom(e);)n.push(result.result),e=e.substring(result.length);return n}function Generator(){this.default_methods={}}function blockWithReturn(t,e){var n=t.getAll(e),r=n[n.length-1];return n[n.length-1]="return "+r,n.join(";\n")}function createMatcher(t,e){if("iden"===e.cont[0].type&&"else"===e.cont[0].cont)return blockWithReturn(t,e.cont.slice(1));for(var n=e.cont[0].cont.cont,r="",i="var ",u=!0,s=!0,o=0;o<n.length;o++)"iden"!==n[o].type?(u||(r+="&&"),u=!1,r+="arguments["+o+"]==="+t.get(n[o])):(s||(i+=","),s=!1,i+=n[o].cont+"=arguments["+o+"]");u||(r+="&&"),r+="arguments.length==="+n.length,s&&(i="");var l=blockWithReturn(t,e.cont.slice(1));return"if("+r+") {\n"+i+";\n"+l+";\n}"}function createFunction(t,e,n){var r=n?-1:0,i=n?"":t.get(e[0]);if("quote"==e[r+1].type){var u=t.getAll(e[r+1].cont.cont),s=blockWithReturn(t,e.slice(r+2)),o="function "+i+"("+u.join(", ")+") {\n";return o+=s,o+=";\n}"}for(var l=e.slice(r+1),o="function "+i+"() {\n",a=0;a<l.length;a++)o+=createMatcher(t,l[a])+"\n";return o+';throw "Unexhaustive matching";\n}'}function generate(t){for(var e=new Generator,n=[],r=0;r<t.length;r++){var i=t[r],u=e[i.type];if(!u)throw"Unexpected symbol "+JSON.stringify(i.cont);n.push(e[i.type](i)+";\n")}var s="";for(method in e.default_methods)s+=defaults[method]+";\n";for(var r=0;r<n.length;r++)s+=n[r];return s}var types={"list-start":{re:/^\(|^\[/,ignore:!1},"list-end":{re:/^\)|^\]/,ignore:!1},number:{re:/^\d*\.\d+|^\d+/,ignore:!1},iden:{re:/^[\w\-+*!@#$%\^&\d\.=<>:]+/,ignore:!1},string:{re:/^"(.*?)"/,ignore:!1},whitespace:{re:/^\s+|^;.*?\n/,ignore:!0},quote:{re:/^'/,ignore:!1}},defaults={map:"function map(f, l){var r=[];for(var i=0;i<l.length;i++)r.push(f(l[i]));return r;}",filter:"function filter(f, l){var r=[];for(var i=0;i<l.length;i++)f(l[i])&&r.push(l[i]);return r;}",reduce:"function reduce(f, v, l){for(var i=0;i<l.length;i++)v=f(v,l[i]);return v;}",type:"function type(a) {return typeof a;}",range:"function range(a) {var r=[];for(var i=0;i<a;i++)r[i]=i;return r;}",apply:"function apply(f, a) {return f.apply(null, a);}"},gen=Generator.prototype;gen.get=function(t){return this[t.type](t)},gen.getAll=function(t,e){e=e||0;for(var n=[];e<t.length;e++)n.push(this.get(t[e]));return n},gen.infix_operators={"+":!0,"-":!0,"/":!0,"*":!0,"%":!0,"&&":!0,"||":!0,"<":!0,">":!0,"<=":!0,">=":!0,"=":"==="},gen.infix=function(t){var e=this.get(t.cont[0]);this.infix_operators[e]!==!0&&(e=this.infix_operators[e]);var n=this.getAll(t.cont.slice(1));return"("+n.join(e)+")"},gen.builtins_fn=function(t){return createFunction(this,t,!0)},gen.builtins_defn=function(t){return createFunction(this,t)},gen.builtins_def=function(t){return"var "+this.get(t[0])+"="+this.get(t[1])},gen.builtins_if=function(t){var e=this.get(t[0]),n=this.get(t[1]),r=t[2]?this.get(t[2]):"undefined";return"("+e+"?"+n+":"+r+")"},gen.builtins_first=function(t){var e=this.get(t[0]);return e+"[0]"},gen.builtins_rest=function(t){var e=this.get(t[0]);return e+".slice(1)"},gen.builtins_try=function(t){var e=this.get(t[0]),n=t[1]?this.get(t[1]):"null";return"try {\n"+e+"\n} catch(error) {\n"+n+";\n}"},gen.string=function(t){return'"'+t.cont+'"'},gen.number=function(t){return t.cont},gen.iden=function(t){return t.cont},gen.quote=function(t){var e=t.cont;if("list"===e.type){for(var n=[],r=e.cont,i=0;i<r.length;i++){var u=r[i];n.push(this.get(u))}return"["+n.join(", ")+"]"}return this.get(u)},gen.list=function(t){var e=this.get(t.cont[0]);if(e.endsWith("}")&&(e="("+e+")"),this["builtins_"+e])return this["builtins_"+e](t.cont.slice(1));if(this.infix_operators[e])return this.infix(t);if(defaults[e]&&(this.default_methods[e]=!0),e.startsWith("."))var n=this.get(t.cont[1])+e+"(",r=2;else{if(e.startsWith(":"))return this.get(t.cont[1])+"."+e.slice(1);var n=e+"(",r=1}return n+=this.getAll(t.cont,r).join(", "),n+=")"};